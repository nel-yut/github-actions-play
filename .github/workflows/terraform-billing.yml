name: Terraform Billing

# hhttps://github.com/infracost/infracost

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
    terraform-plan:
        runs-on: ubuntu-latest
    
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
    
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v2
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ap-northeast-1
    
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v2
          with:
            terraform_version: 1.7.5 
    
        - name: Terraform Init
          working-directory: ./terraform
          run: terraform init
    
        - name: Terraform Plan
          working-directory: ./terraform
          run: terraform plan

        - name: Setup Infracost
          uses: infracost/actions/setup@v1
          with:
             api-key: ${{ secrets.INFRACOST_API_KEY }}
    
        - name: Generate Infracost JSON
          working-directory: ./terraform
          run: infracost breakdown --path plan.json --format json --out-file /tmp/infracost.json
    
        - name: Post Infracost comment
          uses: infracost/actions/comment@v1
          with:
             path: /tmp/infracost.json
             behavior: update 